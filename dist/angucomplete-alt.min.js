/*! Copyright (c) 2014 Hidenari Nozaki and contributors | Licensed under the MIT license */
"use strict";!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],b):b(a.angular)}(window,function(a){a.module("angucomplete-alt",[]).directive("angucompleteAlt",["$q","$parse","$http","$sce","$timeout","$templateCache","$interpolate","$ionicScrollDelegate",function(a,b,c,d,e,f,g,h){function i(b,f,g,i){function z(a){oa=null,b.hideResults(a),document.body.removeEventListener("click",z)}function A(a){return a.which?a.which:a.keyCode}function B(a){"function"==typeof b.selectedObject?b.selectedObject(a):b.selectedObject=a,H(a?!0:!1)}function C(a){return function(c){return b[a]?b[a](c):c}}function D(a){B({originalObject:a}),b.clearSelected&&(b.searchStr=null),W()}function E(a){return b.titleField.split(",").map(function(b){return F(a,b)}).join(" ")}function F(a,b){var c,d;if(b){c=b.split("."),d=a;for(var e=0;e<c.length;e++)d=d[c[e]]}else d=a;return d}function G(a,c){var e,f,g;return g=new RegExp(c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i"),a?(a.match&&a.replace||(a=a.toString()),f=a.match(g),e=f?a.replace(g,'<span class="'+b.matchClass+'">'+f[0]+"</span>"):a,d.trustAsHtml(e)):void 0}function H(a){b.notEmpty=a,ka=b.searchStr,b.fieldRequired&&i&&i.$setValidity(ja,a)}function I(a){var c=A(a);if(c!==m&&c!==k)if(c===l||c===o)a.preventDefault();else if(c===j)a.preventDefault(),!b.showDropdown&&b.searchStr&&b.searchStr.length>=ha&&(X(),b.searching=!0,$(b.searchStr));else if(c===n)W(),b.$apply(function(){ga.val(b.searchStr)});else{if(0===ha&&!b.searchStr)return;b.searchStr&&""!==b.searchStr?b.searchStr.length>=ha&&(X(),ia&&e.cancel(ia),b.searching=!0,ia=e(function(){$(b.searchStr)},b.pause)):b.showDropdown=!1,ka&&ka!==b.searchStr&&!b.clearSelected&&b.$apply(function(){B()})}}function J(a){!b.overrideSuggestions||b.selectedObject&&b.selectedObject.originalObject===b.searchStr||(a&&a.preventDefault(),D(b.searchStr))}function K(a){var b=getComputedStyle(a);return a.offsetHeight+parseInt(b.marginTop,10)+parseInt(b.marginBottom,10)}function L(){return ma.getBoundingClientRect().top+parseInt(getComputedStyle(ma).maxHeight,10)}function M(){return f[0].querySelectorAll(".angucomplete-row")[b.currentIndex]}function N(){return M().getBoundingClientRect().top-(ma.getBoundingClientRect().top+parseInt(getComputedStyle(ma).paddingTop,10))}function O(a){ma.scrollTop=ma.scrollTop+a}function P(){var a=b.results[b.currentIndex];b.matchClass?ga.val(E(a.originalObject)):ga.val(a.title)}function Q(a){var c=A(a),d=null,e=null;c===o&&b.results?(b.currentIndex>=0&&b.currentIndex<b.results.length?(a.preventDefault(),b.selectResult(b.results[b.currentIndex])):(J(a),W()),b.$apply()):c===j&&b.results?(a.preventDefault(),b.currentIndex+1<b.results.length&&b.showDropdown&&(b.$apply(function(){b.currentIndex++,P()}),na&&(d=M(),L()<d.getBoundingClientRect().bottom&&O(K(d))))):c===l&&b.results?(a.preventDefault(),b.currentIndex>=1?(b.$apply(function(){b.currentIndex--,P()}),na&&(e=N(),0>e&&O(e-1))):0===b.currentIndex&&b.$apply(function(){b.currentIndex=-1,ga.val(b.searchStr)})):c===p&&(b.results&&b.results.length>0&&b.showDropdown?-1===b.currentIndex&&b.overrideSuggestions?J():(-1===b.currentIndex&&(b.currentIndex=0),b.selectResult(b.results[b.currentIndex]),b.$digest()):b.searchStr&&b.searchStr.length>0&&J())}function R(a){return function(c,d,e,f){d||e||f||(c=c.data),b.searching=!1,_(F(ca(c),b.remoteUrlDataField),a)}}function S(a,c,d,e){c||d||e||(c=a.status),0!==c&&(b.remoteUrlErrorCallback?b.remoteUrlErrorCallback(a,c,d,e):console&&console.error&&console.error("http error"))}function T(){la&&la.resolve()}function U(d){var e={},f=b.remoteUrl+encodeURIComponent(d);b.remoteUrlRequestFormatter&&(e={params:b.remoteUrlRequestFormatter(d)},f=b.remoteUrl),b.remoteUrlRequestWithCredentials&&(e.withCredentials=!0),T(),la=a.defer(),e.timeout=la.promise,c.get(f,e).success(R(d)).error(S)}function V(c){T(),la=a.defer(),b.remoteApiHandler(c,la.promise).then(R(c))["catch"](S)}function W(){b.showDropdown=!1,b.results=[],ma&&(ma.scrollTop=0)}function X(){b.showDropdown=ea,b.currentIndex=-1,b.results=[]}function Y(a){var c,d,e,f,g=b.searchFields.split(","),h=[];for(c=0;c<b.localData.length;c++){for(d=!1,e=0;e<g.length;e++)f=F(b.localData[c],g[e])||"",d=d||f.toString().toLowerCase().indexOf(a.toString().toLowerCase())>=0;d&&(h[h.length]=b.localData[c])}b.searching=!1,_(h,a)}function Z(a,c,d){if(d)for(var e in c)if(c[e].toLowerCase()===d.toLowerCase())return void b.selectResult(a)}function $(a){!a||a.length<ha||(b.localData?b.$apply(function(){Y(a)}):b.remoteApiHandler?V(a):U(a))}function _(a,c){var d,e,f,g,h,i;if(a&&a.length>0)for(b.results=[],d=0;d<a.length;d++)b.titleField&&""!==b.titleField&&(g=h=E(a[d])),e="",b.descriptionField&&(e=i=F(a[d],b.descriptionField)),f="",b.imageField&&(f=F(a[d],b.imageField)),b.matchClass&&(h=G(g,c),i=G(e,c)),b.results[b.results.length]={title:h,description:i,image:f,originalObject:a[d]},b.autoMatch&&Z(b.results[b.results.length-1],{title:g,desc:e||""},b.searchStr);else b.results=[];0!==b.results.length||fa?(b.showDropdown=!0,qa.scrollTo(0,0)):b.showDropdown=!1;var j=b.results.length>v?v*u:b.results.length*u;fa&&10>j&&(j=u),ma.style.height=j+2+"px"}function aa(){b.localData?_(b.localData,""):b.remoteApiHandler?V(""):U("")}var ba,ca,da,ea,fa,ga=f.find("input"),ha=q,ia=null,ja=w,ka=null,la=null,ma=f[0].querySelector(".angucomplete-dropdown"),na=!1,oa=null,pa=f[0].querySelector("ion-content"),qa=h.$getByHandle(pa.getAttribute("delegate-handle"));f.on("mousedown",function(a){a.target.id?(oa=a.target.id,oa===b.id+"_dropdown"&&document.body.addEventListener("click",z)):oa=a.target.className}),b.currentIndex=null,b.searching=!1,da=b.$watch("initialValue",function(a,c){a&&(da(),"object"==typeof a?(b.searchStr=E(a),B({originalObject:a})):"string"==typeof a&&a.length>0?b.searchStr=a:console&&console.error&&console.error("Tried to set initial value of angucomplete to",a,"which is an invalid value"),H(!0))}),b.clearSearchReslult=function(){b.searchStr&&b.searchStr.length?(b.searchStr="",e(function(){ga[0].focus()})):b.showDropdown&&(b.showDropdown=!1),b.selectedObject=null},b.$on("angucomplete-alt:clearInput",function(a,c){c&&c!==b.id||(b.searchStr=null,B(),H(!1),W())}),b.onFocusHandler=function(){b.focusIn&&b.focusIn(),0!==ha||b.searchStr&&0!==b.searchStr.length||(b.showDropdown=!0,aa())},b.hideResults=function(a){oa&&(oa===b.id+"_dropdown"||oa.indexOf("angucomplete")>=0)?oa=null:(ba=e(function(){W(),b.$apply(function(){b.searchStr&&b.searchStr.length>0&&ga.val(b.searchStr)})},t),T(),b.focusOut&&b.focusOut(),b.overrideSuggestions&&b.searchStr&&b.searchStr.length>0&&-1===b.currentIndex&&J())},b.resetHideResults=function(){ba&&e.cancel(ba)},b.hoverRow=function(a){b.currentIndex=a},b.selectResult=function(a){b.matchClass&&(a.title=E(a.originalObject),a.description=F(a.originalObject,b.descriptionField)),b.clearSelected?b.searchStr=null:b.searchStr=a.title,B(a),W()},b.inputChangeHandler=function(a){return a.length<ha?W():0===a.length&&0===ha&&(b.searching=!1,aa()),b.inputChanged&&(a=b.inputChanged(a)),a},b.fieldRequiredClass&&""!==b.fieldRequiredClass&&(ja=b.fieldRequiredClass),b.minlength&&""!==b.minlength&&(ha=parseInt(b.minlength,10)),b.pause||(b.pause=s),b.clearSelected||(b.clearSelected=!1),b.overrideSuggestions||(b.overrideSuggestions=!1),b.fieldRequired&&i&&H(b.initialValue?!0:!1),b.inputType=g.type?g.type:"text",b.textSearching=g.textSearching?g.textSearching:x,b.textNoResults=g.textNoResults?g.textNoResults:y,ea="false"===b.textSearching?!1:!0,fa="false"===b.textNoResults?!1:!0,b.maxlength=g.maxlength?g.maxlength:r,ga.on("keydown",Q),ga.on("keyup",I),ca=C("remoteUrlResponseFormatter"),b.$on("$destroy",function(){H(!0)}),e(function(){var a=getComputedStyle(ma);na=a.maxHeight&&"auto"===a.overflowY})}var j=40,k=39,l=38,m=37,n=27,o=13,p=9,q=3,r=524288,s=500,t=200,u=41,v=4,w="autocomplete-required",x="Searching...",y="No results found",z="/angucomplete-alt/index.html";return f.put(z,'<div class="angucomplete-holder" ng-class="{\'angucomplete-dropdown-visible\': showDropdown}">   <input id="{{id}}_value" name="{{inputName}}" ng-class="{\'angucomplete-input-not-empty\': notEmpty}" ng-model="searchStr" ng-disabled="disableInput" type="{{inputType}}" placeholder="{{placeholder}}" maxlength="{{maxlength}}" ng-focus="onFocusHandler()" class="{{inputClass}}" ng-focus="resetHideResults()" ng-blur="clearOnBlur!=\'false\' && hideResults($event)" autocapitalize="off" autocorrect="off" autocomplete="off" ng-change="inputChangeHandler(searchStr)" />   <a class="icon ion-ios-close-outline placeholder-icon clear-search-btn" ng-click="clearSearchReslult()"  ng-show="{{enableClearSearchBtn || false}} && (searchStr.length || showDropdown)"></a>   <div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-show="showDropdown">     <div class="angucomplete-searching" ng-show="searching" ng-bind="textSearching"></div>     <div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)" ng-bind="textNoResults"></div>     <ion-content ng-show="showDropdown" delegate-handle="{{id}}_Scroll" has-bouncing="listHasBouncing!=\'false\' && listHasBouncing!=false">     <div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseenter="hoverRow($index)" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}">       <div ng-if="imageField" class="angucomplete-image-holder"> <img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image" />         <div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div>       </div>       <div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div>       <div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div>       <div ng-if="matchClass && result.description && result.description != \'\'" class="angucomplete-description" ng-bind-html="result.description"></div>       <div ng-if="!matchClass && result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div>     </div>     </ion-content>   </div> </div> '),{restrict:"EA",require:"^?form",scope:{selectedObject:"=",disableInput:"=",initialValue:"=",localData:"=",remoteUrlRequestFormatter:"=",remoteUrlRequestWithCredentials:"@",remoteUrlResponseFormatter:"=",remoteUrlErrorCallback:"=",remoteApiHandler:"=",id:"@",type:"@",placeholder:"@",remoteUrl:"@",remoteUrlDataField:"@",titleField:"@",descriptionField:"@",imageField:"@",inputClass:"@",pause:"@",searchFields:"@",minlength:"@",matchClass:"@",clearSelected:"@",overrideSuggestions:"@",fieldRequired:"@",fieldRequiredClass:"@",inputChanged:"=",autoMatch:"@",focusOut:"&",focusIn:"&",inputName:"@",enableClearSearchBtn:"@",clearOnBlur:"@",listHasBouncing:"@"},templateUrl:function(a,b){return b.templateUrl||z},compile:function(a,b){var c=g.startSymbol(),d=g.endSymbol();if("{{"!==c||"}}"!==d){var e=a.html().replace(/\{\{/g,c).replace(/\}\}/g,d);a.html(e)}return i}}}])});